<!DOCTYPE html>
<html>
  <head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
      <div id="map-container"></div>
  </body>
  <script>
    var width = 900,
        height = 600;
    
    var lowColor = '#fffbaf',
        highColor = '#ab2aed';

    var svg = d3.select("#map-container").append("svg")
        .attr("width", width)
        .attr("height", height);

    var projection = d3.geoMercator()
        .scale(50000)
        .center([-73.94, 40.70]); // long, lat of NYC

    var path = d3.geoPath()
        .projection(projection);
    
    d3.csv("rent.csv").then(function(data) {
        console.log(data)

        // create chloropleth scale
        var dataArray = [];
        for (var i = 0; i < data.length; i++) {
            var novRent = data[i]['2021-11']
            if (novRent !== "") {
                dataArray.push(novRent)
            }
        }
        var minVal = d3.min(dataArray)
        var maxVal = d3.max(dataArray)
        var ramp = d3.scaleLinear().domain([minVal * 0.7,maxVal * 0.7]).range([lowColor,highColor])

        d3.json("neighbs.json").then(function(json) {
            // convert topojson to json
            json = topojson.feature(json, json.objects.neighbs).features

            // loop through each neighborhood in the csv file
            for (var i = 0; i < data.length; i++) {

                // grab neighborhood name
                var dataNeighborhood = data[i]['areaName']

                // grab neighborhood rent 
                var dataRent = parseFloat(data[i]['2021-11']);
                if (Number.isNaN(dataRent)) {
                    continue
                }

                // find the corresponding neighborhood inside the json
                for (var j = 0; j < json.length; j++) {
                    var jsonNeighborhood = json[j].properties.name

                    if (dataNeighborhood == jsonNeighborhood) {

                        // copy data value into json
                        json[j].properties['rent'] = dataRent;

                        // stop looking through the json
                        break;
                    }
                }
            }

            svg
            .selectAll("path")
            .data(json)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("fill", "#808080")
            .attr("stroke", "#000000")
            .attr("stroke-width", 0.5)
            .style("fill", function(d) { return ramp(d.properties.rent) });

            // add a legend
		    var w = 140, h = 300;

            var key = d3.select("#map-container")
                .append("svg")
                .attr("width", w)
                .attr("height", h)
                .attr("class", "legend");

            var legend = key.append("defs")
                .append("svg:linearGradient")
                .attr("id", "gradient")
                .attr("x1", "100%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "100%")
                .attr("spreadMethod", "pad");

            legend.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", highColor)
                .attr("stop-opacity", 1);
                
            legend.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", lowColor)
                .attr("stop-opacity", 1);

            key.append("rect")
                .attr("width", w - 100)
                .attr("height", h)
                .style("fill", "url(#gradient)")
                .attr("transform", "translate(0,10)");

            var y = d3.scaleLinear()
                .range([h, 0])
                .domain([minVal, maxVal]);

            var yAxis = d3.axisRight(y);

            key.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(41,10)")
                .call(yAxis)
        });
    })
    
</script>
</html>
